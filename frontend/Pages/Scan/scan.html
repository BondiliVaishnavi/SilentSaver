<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SilentSaver ‚Ä¢ Scan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/html5-qrcode"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="scan.css"/>
  
</head>
<body>
  <div class="container">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/14/Walmart_Spark.svg/2048px-Walmart_Spark.svg.png" class="logo" alt="Walmart Logo" />
    <h2>Scan & Save with Walmart</h2>

    <div class="barcode-input-wrapper" id="input-wrapper">
      <input type="text" id="barcode-input" placeholder="Enter or scan barcode" onkeydown="handleEnter(event)">
      <i class="fas fa-camera scan-icon" onclick="openScanner()"></i>
    </div>

    <button class="action-btn" id="submit-btn" onclick="submitCode()">Submit</button>

    <div id="reader"></div>

    <label class="upload-label" id="upload-label" for="upload-image">üì∑ Upload Barcode Image</label>
    <input type="file" id="upload-image" accept="image/*" onchange="scanFromFile(this)" />
  </div>

  <script>
    const validCodes = {
      "MILK123": { name: "Amul Milk", oldPrice: 50, newPrice: 40, units: 5, days: 2, views: 10 },
      "JUICE456": { name: "Real Juice", oldPrice: 90, newPrice: 75, units: 3, days: 4, views: 8 },
      "EGG789": { name: "Eggs 6pc", oldPrice: 65, newPrice: 55, units: 8, days: 1, views: 11 }
    };

    let html5Qr;

    function openScanner() {
      // Hide input and submit
      document.getElementById("input-wrapper").style.display = "none";
      document.getElementById("submit-btn").style.display = "none";

      // Show upload
      document.getElementById("upload-label").style.display = "inline-block";

      // Start scanner
      const reader = document.getElementById("reader");
      reader.innerHTML = "";
      html5Qr = new Html5Qrcode("reader");

      html5Qr.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          html5Qr.stop().then(() => {
            handleScan(decodedText.trim());
          });
        },
        (error) => console.log(error)
      );
    }

    function scanFromFile(input) {
      if (!input.files || input.files.length === 0) return;

      const file = input.files[0];
      const scanner = new Html5Qrcode("reader");

      scanner.scanFile(file, true)
        .then(decodedText => {
          scanner.clear();
          handleScan(decodedText.trim());
        })
        .catch(err => {
          alert("‚ö†Ô∏è Could not scan the image.");
          console.error("Scan failed:", err);
        });
    }

    function handleEnter(e) {
      if (e.key === "Enter") submitCode();
    }

    function submitCode() {
      const code = document.getElementById("barcode-input").value.trim();
      handleScan(code);
    }

    function handleScan(code) {
      const result = validCodes[code];
      if (result) {
        localStorage.setItem("deal", JSON.stringify(result));
        window.location.href = "../Reward/reward.html";

      } else {
        alert("‚ùå No better deal found.");
      }
    }
  </script>
</body>
</html>
